<!DOCTYPE html>
<html>
<head>

<meta name="viewport" content="minimum-scale=1.0, width=device-width, user-scalable=yes" />

<style>

#objModal{
position: absolute;
/*display: none*/;
top: 0px;
left: 0px;	
background: #eee;
opacity: 0.7;
width: 100%;
height: 100%;
z-index: 10000;
}

#objClip{

background: #fff;
opacity: 1;
position: absolute;
top: 10px;
left: 5px;
/*width = 320;*/
border: buttonhighlight 2px inset;
z-index: 10000;
}

#divVideo{
position: relative;
/*width: 100%;*/
}

#resPhoto{
position: absolute;
top: 0px;
left: 0px;
width: 100%;
display: none;
}

#canvas, #video{
width: 100%;
height: 100%;
}

#buttonZone{
background: #eee;
/*display: none;*/
}

#buttonZone button{
    width: 32%;
    padding: inherit !important;
	border: buttonhighlight 2px outset;
	display: inline;
}

#butFile{
display: none;
}

#mailTXT{
width: 98%;	
}

@media screen and (max-width: 540px), only screen and (min-device-width: 320px) and (max-device-width: 480px), only screen and (-moz-min-device-pixel-ratio: 2), only screen and (-o-min-device-pixel-ratio: 2/1), only screen and (-webkit-min-device-pixel-ratio: 2), only screen and (min-device-pixel-ratio: 2) 
{ 

#buttonZone button{
	font-size: 1.2em;
    height: 40px;

}

#mailTXT{
	font-size: 1.4em;
	width: 92%;
}

}
	
</style>

<script type="text/javascript"> 
<!--
var supportStorage = (function() {  // Detect localStorage availability for Quiz history, Quiz templates (Custom Quiz) and Overall analysis 
	try {
		var mod = "test";
		localStorage.setItem(mod, mod);
		localStorage.removeItem(mod);
		return true;
	} catch (exception) {
		return false;
	}
}());

var nodejsHost = "http://cdore.no-ip.biz:3000/nod/";
//"https://sslgserver-googleserv.44fs.preview.openshiftapps.com/";
//"http://192.168.2.10:3000/nod/";
//"http://cdore.no-ip.biz:3000/nod/";

function getWidth(){
return 300;
}


function init(){
mailTXT = document.getElementById('mailTXT');

if (supportStorage){
var eMailAdress = localStorage.getItem("eMailAdress");
if (eMailAdress)
	mailTXT.value = eMailAdress;
}

(function() {

var data = null;
var vendorURL;
  var streaming = false,
      objModal     = document.querySelector('#objModal'),
	  objClip      = document.querySelector('#objClip'),
	  divVideo     = document.querySelector('#divVideo'),
	  video        = document.querySelector('#video'),
      canvas       = document.querySelector('#canvas'),
      resPhoto     = document.querySelector('#resPhoto'),
	  buttonZone   = document.querySelector('#buttonZone'),
	  butRetry     = document.querySelector('#butRetry'),
	  butOk        = document.querySelector('#butOk'),
	  butCancel    = document.querySelector('#butCancel'),
	  butFile      = document.querySelector('#butFile'),
	  butCallFile  = document.querySelector('#butCallFile'),
      width = getWidth(),
      height = 0;

	  //canvas2 = document.getElementById('canvas2');
	var ctx;
//	= canvas2.getContext("2d");

  navigator.getMedia = ( navigator.getUserMedia ||
                         navigator.webkitGetUserMedia ||
                         navigator.mozGetUserMedia ||
                         navigator.msGetUserMedia);

if (navigator.getMedia){
  navigator.getMedia(
    {
      video: true,
      audio: false
    },
    function(stream) {
      if (navigator.mozGetUserMedia) {
        video.mozSrcObject = stream;
      } else {
        vendorURL = window.URL || window.webkitURL;
        video.src = vendorURL.createObjectURL(stream);
      }
      video.play();
	objModal.style.display="inherit";
	butCancel.addEventListener('click', function(ev){
		stopStream(stream);
		objModal.style.display="none";
		ev.preventDefault();
	}, false);
    },
    function(err) {   // Video not available
		resPhoto.style.display="inherit";
		butRetry.style.display="none";
		//butCallFile.style.display="inherit";
		butFile.onchange = readImage;
		ctx = canvas.getContext("2d");
		buttonZone.style.display="inherit";
      console.log("An error occured! " + err);
	  butCancel.addEventListener('click', function(ev){
		objModal.style.display="none";
		ev.preventDefault();
	  }, false);
    }
  );
}else{ //No media availaible
  var data = null,
      objModal     = document.querySelector('#objModal'),
	  objClip      = document.querySelector('#objClip'),
	  divVideo     = document.querySelector('#divVideo'),
	  video        = document.querySelector('#video'),
      canvas       = document.querySelector('#canvas'),
      resPhoto     = document.querySelector('#resPhoto'),
	  buttonZone   = document.querySelector('#buttonZone'),
	  butRetry     = document.querySelector('#butRetry'),
	  butOk        = document.querySelector('#butOk'),
	  butCancel    = document.querySelector('#butCancel'),
	  butFile      = document.querySelector('#butFile'),
	  butCallFile  = document.querySelector('#butCallFile');
	  divVideo.style.height = getWidth()  + "px";
	  canvas.style.height = getWidth()  + "px";
		resPhoto.style.display="inherit";
		butRetry.style.display="none";
		//video.style.display="none";
		//butCallFile.style.display="inherit";
		butFile.onchange = readImage;
		var ctx = canvas.getContext("2d");
		buttonZone.style.display="inherit";
	  butCancel.addEventListener('click', function(ev){
		objModal.style.display="none";
		ev.preventDefault();
	  }, false);
}

	divVideo.style.width = getWidth()  + "px";
	objClip.style.width = getWidth()  + "px";
	objClip.style.left = (((objModal.offsetWidth - getWidth()) / 2) - 5) + "px";

    video.addEventListener('canplay', function(ev){
    if (!streaming) {
      height = video.videoHeight / (video.videoWidth/width);
	  divVideo.setAttribute('height', height);
      video.setAttribute('width', width);
      video.setAttribute('height', height);
      canvas.setAttribute('width', width);
      canvas.setAttribute('height', height);
      streaming = true;
    }
  }, false);


  function takepicture() {
    canvas.width = width;
    canvas.height = height;
    canvas.getContext('2d').drawImage(video, 0, 0, width, height);
    data = canvas.toDataURL('image/png');
	buttonZone.style.display="inherit";
  }

  video.addEventListener('click', function(ev){
	resPhoto.style.display="inherit";
      takepicture();
    ev.preventDefault();
  }, false);

  butRetry.addEventListener('click', function(ev){
	resPhoto.style.display="none";
	data = null;
	ev.preventDefault();
  }, false);

  butOk.addEventListener('click', function(ev){
    if (data == null)
		takepicture();
    if (capture(data))
		butCancel.click();
    ev.preventDefault();
  }, false);

  
function readImage() {
    if ( this.files && this.files[0] ) {
        var FR= new FileReader();
        FR.onload = function(e) {
           var img = new Image();
           img.src = e.target.result;
           img.onload = function() {
				height = width * img.height / img.width;
             ctx.drawImage(img, 0, 0, width, height);
			 data = canvas.toDataURL('image/png');
           };
        };       
        FR.readAsDataURL( this.files[0] );
    }
}
  
})();

}

function stopStream(stream) {
if (stream){
	stream.getVideoTracks().forEach(function (track) {
		track.stop();
	});
	}
}

function capture(data){
var eMailAdress = mailTXT.value;
if (eMailAdress && eMailAdress != ""){
	if (supportStorage)
		localStorage.setItem("eMailAdress", eMailAdress);
}else{
	alert("S.v.p. saisir une adresse courriel.");
	mailTXT.focus();
	return false;
}
//alert(data);
sendServ(eMailAdress, data);
return true;
}

function sendServ(eMailAdress, data){
	var strCom = nodejsHost + "sendImage?" ;
	var fd = new FormData();
	fd.append("mailInfo", eMailAdress);
	fd.append("testInfo", "test");
	fd.append("afile", data);
 
  var xhr = new XMLHttpRequest(); 

  xhr.onloadend = function() {
    var text = xhr.responseText;
    //alert('Response from CORS request to : ' + text);
  };
	xhr.open("POST", strCom);
	xhr.setRequestHeader("Content-Type", "multipart/form-data");
	xhr.send(fd);	
}

	
// -->
</script> 
		
</head>
<body onload="init()">

<!--<button id="startbutton">Prendre une photo</button>
<canvas id="canvas"></canvas>
<img src="http://placekitten.com/g/320/261" id="photo" alt="photo">// -->

<div id="objModal">
<div id="objClip">
<div id="divVideo">
<video id="video"></video>
<div id="resPhoto"><canvas id="canvas"></canvas></div>
</div>
<div id="buttonZone">


<button id="butRetry">Reprendre</button>
<button id="butCallFile" onclick="butFile.click()">Photo</button>
<button id="butOk">Ok</button>
<button id="butCancel">Annuler</button>
<input id="mailTXT" type="email" name="email" placeholder="utilisateur@xxxxx.yyy">
<input id="butFile" type="file" accept="image/*;capture=camera" />
</div>
</div>
</div>

</body>
</html>
